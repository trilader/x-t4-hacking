local fptipi = Proto("fptipi", "Fuji PTP/IP")

local packet_types = {
    [1] = "Request",
    [2] = "Data",
    [3] = "Response",
}

local response_codes = {
    [0x2000] = "Undefined",
    [0x2001] = "OK",
    [0x2002] = "GeneralError",
    [0x2003] = "SessionNotOpen",
    [0x2004] = "InvalidTransactionID",
    [0x2005] = "OperationNotSupported",
    [0x2006] = "ParameterNotSupported",
    [0x2007] = "IncompleteTransfer",
    [0x2008] = "InvalidStorageId",
    [0x2009] = "InvalidObjectHandle",
    [0x200A] = "DevicePropNotSupported",
    [0x200B] = "InvalidObjectFormatCode",
    [0x200C] = "StoreFull",
    [0x200D] = "ObjectWriteProtected",
    [0x200E] = "StoreReadOnly",
    [0x200F] = "AccessDenied",
    [0x2010] = "NoThumbnailPresent",
    [0x2011] = "SelfTestFailed",
    [0x2012] = "PartialDeletion",
    [0x2013] = "StoreNotAvailable",
    [0x2014] = "SpecificationByFormatUnsupported",
    [0x2015] = "NoValidObjectInfo",
    [0x2016] = "InvalidCodeFormat",
    [0x2017] = "UnknownVendorCode",
    [0x2018] = "CaptureAlreadyTerminated",
    [0x2019] = "DeviceBusy",
    [0x201A] = "InvalidParentObject",
    [0x201B] = "InvalidDevicePropFormat",
    [0x201C] = "InvalidDevicePropValue",
    [0x201D] = "InvalidParameter",
    [0x201E] = "SessionAlreadyOpened",
    [0x201F] = "TransactionCanceled",
    [0x2020] = "SpecificationOfDestinationUnsupported",
    [0x2021] = "InvalidEnumHandle",
    [0x2022] = "NoStreamEnabled",
    [0x2023] = "InvalidDataSet",
}

local cmds = {
    [0x1000] = "Undefined",
    [0x1001] = "GetDeviceInfo",
    [0x1002] = "OpenSession",
    [0x1003] = "CloseSession",
    [0x1004] = "GetStorageIDs",
    [0x1005] = "GetStorageInfo",
    [0x1006] = "GetNumObjects",
    [0x1007] = "GetObjectHandles",
    [0x1008] = "GetObjectInfo",
    [0x1009] = "GetObject",
    [0x100A] = "GetThumb",
    [0x100B] = "DeleteObject",
    [0x100C] = "SendObjectInfo",
    [0x100D] = "SendObject",
    [0x100E] = "InitiateCapture",
    [0x100F] = "FormatStore",
    [0x1010] = "ResetDevice",
    [0x1011] = "SelfTest",
    [0x1012] = "SetObjectProtection",
    [0x1013] = "PowerDown",
    [0x1014] = "GetDevicePropDesc",
    [0x1015] = "GetDevicePropValue",
    [0x1016] = "SetDevicePropValue",
    [0x1017] = "ResetDevicePropValue",
    [0x1018] = "TerminateOpenCapture",
    [0x1019] = "MoveObject",
    [0x101A] = "CopyObject",
    [0x101B] = "GetPartialObject",
    [0x101C] = "InitiateOpenCapture",
    [0x101D] = "StartEnumHandles",
    [0x101E] = "EnumHandles",
    [0x101F] = "StopEnumHandles",
    [0x1020] = "GetVendorExtensionMaps",
    [0x1021] = "GetVendorDeviceInfo",
    [0x1022] = "GetResizedImageObject",
    [0x1023] = "GetFilesystemManifest",
    [0x1024] = "GetStreamInfo",
    [0x1025] = "GetStream",
}

local f_length = ProtoField.new("Length", "fptpip.length", ftypes.UINT32)
local f_ptype = ProtoField.new("Packet Type", "fptpip.ptype", ftypes.UINT16, packet_types)
local f_cmd = ProtoField.new("Command", "fptpip.cmd", ftypes.UINT16, cmds, base.HEX)
local f_result = ProtoField.new("Response Code", "fptpip.responsecode", ftypes.UINT16, response_codes, base.HEX)
local f_transaction = ProtoField.new("Transaction", "fptpip.transaction", ftypes.UINT32)
local f_params = ProtoField.new("Prameters", "fptpip.parameters", ftypes.BYTES)
local f_param = ProtoField.new("Parameter", "fptpip.parameter", ftypes.UINT32, nil, base.HEX)
local f_data = ProtoField.new("Data", "fptpip.data", ftypes.BYTES)

local dpcs = {
    [0x5000] = "Undefined",
    [0x5001] = "BatteryLevel",
    [0x5002] = "FunctionalMode",
    [0x5003] = "ImageSize",
    [0x5004] = "CompressionSetting",
    [0x5005] = "WhiteBalance",
    [0x5006] = "RGBGain",
    [0x5007] = "FNumber",
    [0x5008] = "FocalLength",
    [0x5009] = "FocusDistance",
    [0x500A] = "FocusMode",
    [0x500B] = "ExposureMeteringMode",
    [0x500C] = "FlashMode",
    [0x500D] = "ExposureTime",
    [0x500E] = "ExposureProgramMode",
    [0x500F] = "ExposureIndex",
    [0x5010] = "ExposureBiasCompensation",
    [0x5011] = "DateTime",
    [0x5012] = "CaptureDelay",
    [0x5013] = "StillCaptureMode",
    [0x5014] = "Contrast",
    [0x5015] = "Sharpness",
    [0x5016] = "DigitalZoom",
    [0x5017] = "EffectMode",
    [0x5018] = "BurstNumber",
    [0x5019] = "BurstInterval",
    [0x501A] = "TimelapseNumber",
    [0x501B] = "TimelapseInterval",
    [0x501C] = "FocusMeteringMode",
    [0x501D] = "UploadURL",
    [0x501E] = "Artist",
    [0x501F] = "CopyrightInfo",
    [0x5020] = "SupportedStreams",
    [0x5021] = "EnabledStreams",
    [0x5022] = "VideoFormat",
    [0x5023] = "VideoResolution",
    [0x5024] = "VideoQuality",
    [0x5025] = "VideoFrameRate",
    [0x5026] = "VideoContrast",
    [0x5027] = "VideoBrightness",
    [0x5028] = "AudioFormat",
    [0x5029] = "AudioBitrate",
    [0x502A] = "AudioSamplingRate",
    [0x502B] = "AudioBitPerSample",
    [0x502C] = "AudioVolume",

    [0xD001] = "FUJI_FilmSimulation",
    [0xD002] = "FUJI_FilmSimulationTune",
    [0xD007] = "FUJI_DRangeMode",
    [0xD008] = "FUJI_ColorMode",
    [0xD00A] = "FUJI_ColorSpace",
    [0xD00B] = "FUJI_WhitebalanceTune1",
    [0xD00C] = "FUJI_WhitebalanceTune2",
    [0xD017] = "FUJI_ColorTemperature",
    [0xD018] = "FUJI_Quality",
    [0xD019] = "FUJI_RecMode",
    [0xD01A] = "FUJI_LiveViewBrightness",
    [0xD01B] = "FUJI_ThroughImageZoom",
    [0xD01C] = "FUJI_NoiseReduction",
    [0xD01D] = "FUJI_MacroMode",
    [0xD01E] = "FUJI_LiveViewStyle",
    [0xD020] = "FUJI_FaceDetectionMode",
    [0xD021] = "FUJI_RedEyeCorrectionMode",
    [0xD022] = "FUJI_RawCompression",
    [0xD023] = "FUJI_GrainEffect",
    [0xD024] = "FUJI_SetEyeAFMode",
    [0xD025] = "FUJI_FocusPoints",
    [0xD026] = "FUJI_MFAssistMode",
    [0xD027] = "FUJI_InterlockAEAFArea",
    [0xD028] = "FUJI_CommandDialMode",
    [0xD029] = "FUJI_Shadowing",
    [0xD02A] = "FUJI_ExposureIndex",
    [0xD02B] = "FUJI_MovieISO",
    [0xD02E] = "FUJI_WideDynamicRange",
    [0xD02F] = "FUJI_TNumber",
    [0xD100] = "FUJI_Comment",
    [0xD101] = "FUJI_SerialMode",
    [0xD102] = "FUJI_ExposureDelay",
    [0xD103] = "FUJI_PreviewTime",
    [0xD104] = "FUJI_BlackImageTone",
    [0xD105] = "FUJI_Illumination",
    [0xD106] = "FUJI_FrameGuideMode",
    [0xD107] = "FUJI_ViewfinderWarning",
    [0xD108] = "FUJI_AutoImageRotation",
    [0xD109] = "FUJI_DetectImageRotation",
    [0xD10A] = "FUJI_ShutterPriorityMode1",
    [0xD10B] = "FUJI_ShutterPriorityMode2",
    [0xD112] = "FUJI_AFIlluminator",
    [0xD113] = "FUJI_Beep",
    [0xD114] = "FUJI_AELock",
    [0xD115] = "FUJI_ISOAutoSetting1",
    [0xD116] = "FUJI_ISOAutoSetting2",
    [0xD117] = "FUJI_ISOAutoSetting3",
    [0xD118] = "FUJI_ExposureStep",
    [0xD119] = "FUJI_CompensationStep",
    [0xD11A] = "FUJI_ExposureSimpleSet",
    [0xD11B] = "FUJI_CenterPhotometryRange",
    [0xD11C] = "FUJI_PhotometryLevel1",
    [0xD11D] = "FUJI_PhotometryLevel2",
    [0xD11E] = "FUJI_PhotometryLevel3",
    [0xD11F] = "FUJI_FlashTuneSpeed",
    [0xD120] = "FUJI_FlashShutterLimit",
    [0xD121] = "FUJI_BuiltinFlashMode",
    [0xD122] = "FUJI_FlashManualMode",
    [0xD123] = "FUJI_FlashRepeatingMode1",
    [0xD124] = "FUJI_FlashRepeatingMode2",
    [0xD125] = "FUJI_FlashRepeatingMode3",
    [0xD126] = "FUJI_FlashCommanderMode1",
    [0xD127] = "FUJI_FlashCommanderMode2",
    [0xD128] = "FUJI_FlashCommanderMode3",
    [0xD129] = "FUJI_FlashCommanderMode4",
    [0xD12A] = "FUJI_FlashCommanderMode5",
    [0xD12B] = "FUJI_FlashCommanderMode6",
    [0xD12C] = "FUJI_FlashCommanderMode7",
    [0xD12D] = "FUJI_ModelingFlash",
    [0xD12E] = "FUJI_BKT",
    [0xD12F] = "FUJI_BKTChange",
    [0xD130] = "FUJI_BKTOrder",
    [0xD131] = "FUJI_BKTSelection",
    [0xD132] = "FUJI_AEAFLockButton",
    [0xD133] = "FUJI_CenterButton",
    [0xD134] = "FUJI_MultiSelectorButton",
    [0xD136] = "FUJI_FunctionLock",
    [0xD145] = "FUJI_Password",
    [0xD146] = "FUJI_ChangePassword",
    [0xD147] = "FUJI_CommandDialSetting1",
    [0xD148] = "FUJI_CommandDialSetting2",
    [0xD149] = "FUJI_CommandDialSetting3",
    [0xD14A] = "FUJI_CommandDialSetting4",
    [0xD14B] = "FUJI_ButtonsAndDials",
    [0xD14C] = "FUJI_NonCPULensData",
    [0xD14E] = "FUJI_MBD200Batteries",
    [0xD14F] = "FUJI_AFOnForMBD200Batteries",
    [0xD153] = "FUJI_FirmwareVersion",
    [0xD154] = "FUJI_ShotCount",
    [0xD155] = "FUJI_ShutterExchangeCount",
    [0xD157] = "FUJI_WorldClock",
    [0xD158] = "FUJI_TimeDifference1",
    [0xD159] = "FUJI_TimeDifference2",
    [0xD15A] = "FUJI_Language",
    [0xD15B] = "FUJI_FrameNumberSequence",
    [0xD15C] = "FUJI_VideoMode",
    [0xD15D] = "FUJI_SetUSBMode",
    [0xD161] = "FUJI_CommentWriteSetting",
    [0xD162] = "FUJI_BCRAppendDelimiter",
    [0xD167] = "FUJI_CommentEx",
    [0xD168] = "FUJI_VideoOutOnOff",
    [0xD16F] = "FUJI_CropMode",
    [0xD170] = "FUJI_LensZoomPos",
    [0xD171] = "FUJI_FocusPosition",
    [0xD173] = "FUJI_LiveViewImageQuality",
    [0xD174] = "FUJI_LiveViewImageSize",
    [0xD175] = "FUJI_LiveViewCondition",
    [0xD176] = "FUJI_StandbyMode",
    [0xD177] = "FUJI_LiveViewExposure",
    [0xD178] = "FUJI_LiveViewWhiteBalance",
    [0xD179] = "FUJI_LiveViewWhiteBalanceGain",
    [0xD17A] = "FUJI_LiveViewTuning",
    [0xD17C] = "FUJI_FocusMeteringMode",
    [0xD17D] = "FUJI_FocusLength",
    [0xD17E] = "FUJI_CropAreaFrameInfo",
    [0xD17F] = "FUJI_ResetSetting",
    [0xD184] = "FUJI_IOPCode",
    [0xD186] = "FUJI_TetherRawConditionCode",
    [0xD187] = "FUJI_TetherRawCompatibilityCode",
    [0xD200] = "FUJI_LightTune",
    [0xD201] = "FUJI_ReleaseMode",
    [0xD202] = "FUJI_BKTFrame1",
    [0xD203] = "FUJI_BKTFrame2",
    [0xD204] = "FUJI_BKTStep",
    [0xD205] = "FUJI_ProgramShift",
    [0xD206] = "FUJI_FocusAreas",
    [0xD207] = "FUJI_PriorityMode",
    [0xD209] = "FUJI_AFStatus",
    [0xD20B] = "FUJI_DeviceName",
    [0xD20C] = "FUJI_MediaRecord",
    [0xD20D] = "FUJI_MediaCapacity",
    [0xD20E] = "FUJI_FreeSDRAMImages",
    [0xD211] = "FUJI_MediaStatus",
    [0xD212] = "FUJI_CurrentState",
    [0xD213] = "FUJI_AELock2",
    [0xD215] = "FUJI_Copyright",
    [0xD216] = "FUJI_Copyright2",
    [0xD218] = "FUJI_Aperture",
    [0xD219] = "FUJI_ShutterSpeed",
    [0xD21B] = "FUJI_DeviceError",
    [0xD222] = "FUJI_SensitivityFineTune1",
    [0xD223] = "FUJI_SensitivityFineTune2",
    [0xD229] = "FUJI_CaptureRemaining",
    [0xD22A] = "FUJI_MovieRemainingTime",
    [0xD230] = "FUJI_ForceMode",
    [0xD240] = "FUJI_ShutterSpeed2",
    [0xD241] = "FUJI_ImageAspectRatio",
    [0xD242] = "FUJI_BatteryLevel",
    [0xD310] = "FUJI_TotalShotCount",
    [0xD320] = "FUJI_HighLightTone",
    [0xD321] = "FUJI_ShadowTone",
    [0xD322] = "FUJI_LongExposureNR",
    [0xD323] = "FUJI_FullTimeManualFocus",
    [0xD332] = "FUJI_ISODialHn1",
    [0xD333] = "FUJI_ISODialHn2",
    [0xD33F] = "FUJI_ViewMode1",
    [0xD340] = "FUJI_ViewMode2",
    [0xD343] = "FUJI_DispInfoMode",
    [0xD346] = "FUJI_LensISSwitch",
    [0xD347] = "FUJI_FocusPoint",
    [0xD34A] = "FUJI_InstantAFMode",
    [0xD34B] = "FUJI_PreAFMode",
    [0xD34C] = "FUJI_CustomSetting",
    [0xD34D] = "FUJI_LMOMode",
    [0xD34E] = "FUJI_LockButtonMode",
    [0xD34F] = "FUJI_AFLockMode",
    [0xD350] = "FUJI_MicJackMode",
    [0xD351] = "FUJI_ISMode",
    [0xD352] = "FUJI_DateTimeDispFormat",
    [0xD353] = "FUJI_AeAfLockKeyAssign",
    [0xD354] = "FUJI_CrossKeyAssign",
    [0xD355] = "FUJI_SilentMode",
    [0xD356] = "FUJI_PBSound",
    [0xD358] = "FUJI_EVFDispAutoRotate",
    [0xD359] = "FUJI_ExposurePreview",
    [0xD35A] = "FUJI_DispBrightness1",
    [0xD35B] = "FUJI_DispBrightness2",
    [0xD35C] = "FUJI_DispChroma1",
    [0xD35D] = "FUJI_DispChroma2",
    [0xD35E] = "FUJI_FocusCheckMode",
    [0xD35F] = "FUJI_FocusScaleUnit",
    [0xD361] = "FUJI_SetFunctionButton",
    [0xD363] = "FUJI_SensorCleanTiming",
    [0xD364] = "FUJI_CustomAutoPowerOff",
    [0xD365] = "FUJI_FileNamePrefix1",
    [0xD366] = "FUJI_FileNamePrefix2",
    [0xD36A] = "FUJI_BatteryInfo1",
    [0xD36B] = "FUJI_BatteryInfo2",
    [0xD36D] = "FUJI_LensNameAndSerial",
    [0xD36E] = "FUJI_CustomDispInfo",
    [0xD36F] = "FUJI_FunctionLockCategory1",
    [0xD370] = "FUJI_FunctionLockCategory2",
    [0xD371] = "FUJI_CustomPreviewTime",
    [0xD372] = "FUJI_FocusArea1",
    [0xD373] = "FUJI_FocusArea2",
    [0xD374] = "FUJI_FocusArea3",
    [0xD375] = "FUJI_FrameGuideGridInfo1",
    [0xD376] = "FUJI_FrameGuideGridInfo2",
    [0xD377] = "FUJI_FrameGuideGridInfo3",
    [0xD378] = "FUJI_FrameGuideGridInfo4",
    [0xD38A] = "FUJI_LensUnknownData",
    [0xD38C] = "FUJI_LensZoomPosCaps",
    [0xD38D] = "FUJI_LensFNumberList",
    [0xD38E] = "FUJI_LensFocalLengthList",
    [0xD390] = "FUJI_FocusLimiter",
    [0xD395] = "FUJI_FocusArea4",
    [0xDF01] = "FUJI_InitSequence",
    [0xDF24] = "FUJI_AppVersion",
}

local f_dpc = ProtoField.new("PropCode", "fptpip.dpc", ftypes.UINT32, dpcs, base.HEX)

fptipi.fields = {f_length, f_ptype, f_cmd, f_result, f_transaction, f_dpc, f_params, f_param, f_data}

local next_is_data = false

function fptipi.dissector(tvbuf,pktinfo,root)
    pktinfo.cols.protocol:set("Fuji PTP/IP")
    local pktlen = tvbuf:reported_length_remaining()
    local tree = root:add(fptipi, tvbuf:range(0,pktlen))

    --[[if next_is_data then
        next_is_data = false
        tree:add(f_data, tvbuf:range(0, pktlen))
        return
    end--]]

    tree:add_le(f_length, tvbuf:range(0,4))
    --local length = tvbuf:range(0,4):uint()
    --pktinfo.cols.info:set("(".. length ..")")
    local ptype = tvbuf:range(4,2):le_uint()
    local cmd = tvbuf:range(6,2):le_uint()
    tree:add_le(f_ptype, tvbuf:range(4,2))
    if ptype == 3 then
        tree:add_le(f_result, tvbuf:range(6,2))
    else
        tree:add_le(f_cmd, tvbuf:range(6,2))
    end
    tree:add_le(f_transaction, tvbuf:range(8,4))

    next_is_data = ptype == 2

    if pktlen <= 12 then
        return
    end

    if pytpe ~= 2 and cmd >= 0x1014 and cmd <= 0x10167 then
        tree:add_le(f_dpc, tvbuf:range(12, 4))
    else
        local ptree = tree:add(f_params, tvbuf(12, pktlen-12), "", "Parameters")
        if ptype == 1 or ptype==3 then
            n = 1
            for i=12,pktlen,4 do
                if i + 4 <= pktlen then
                    ptree:add_le(f_param, tvbuf:range(i,4))
                end
                n = n + 1
            end
        end
    end
end

DissectorTable.get("tcp.port"):add(15740, fptipi)
